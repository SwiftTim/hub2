"use client"

import { Button } from "@/components/ui/button"
import { Download } from "lucide-react"
import jsPDF from "jspdf"
import "jspdf-autotable"

// Extend jsPDF with autoTable
interface jsPDFWithAutoTable extends jsPDF {
  autoTable: (options: any) => jsPDF;
}

export function DownloadResultsButton({ results, user }: { results: any[], user: any }) {
  const handleDownload = () => {
    const doc = new jsPDF() as jsPDFWithAutoTable;

    // Add header
    doc.setFontSize(18)
    doc.text("Academic Results", 14, 22)
    doc.setFontSize(11)
    doc.text(`Student: ${user.full_name || user.email}`, 14, 30)
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 36)

    // Add table
    doc.autoTable({
      startY: 50,
      head: [["Title", "Type", "Score", "Submitted On", "Status"]],
      body: results.map(r => [
        r.title,
        r.type,
        r.score !== null ? `${r.score} / ${r.total_marks}` : 'Not Graded',
        r.date ? new Date(r.date).toLocaleDateString() : 'N/A',
        r.status
      ]),
    })

    // Add footer
    const pageCount = doc.internal.getNumberOfPages()
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i)
      doc.setFontSize(9)
      doc.text(`Page ${i} of ${pageCount}`, 14, doc.internal.pageSize.height - 10)
      doc.text(`Generated by University Management System`, doc.internal.pageSize.width - 14, doc.internal.pageSize.height - 10, { align: 'right' })
    }

    doc.save(`academic-results-${user.id}.pdf`)
  }

  return (
    <Button onClick={handleDownload} disabled={results.length === 0}>
      <Download className="mr-2 h-4 w-4" />
      Download PDF
    </Button>
  )
}
